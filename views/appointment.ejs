<!DOCTYPE html>
<html lang="en">

<%- include('layouts/header'); -%>

    <body>
        <%- include('layouts/nav'); -%>
            <header class="masthead">
                <div class="container position-relative px-4 px-lg-5">
                    <div class="row gx-4 gx-lg-5 justify-content-center">
                        <div class="col-md-10 col-lg-8 col-xl-7">
                            <div class="page-heading">
                                <h1>Appointments</h1>
                                <span class="subheading">Create an available appointment for the driving test</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="container">
                <h1>Appointment Management</h1>
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="date">Select Date:</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label>Select Time Slots:</label>
                        <div id="timeSlotsContainer">
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">9:00 AM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">9:30 AM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">10:00 AM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">10:30 AM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">11:00 AM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">11:30 AM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">12:00 PM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">12:30 PM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">01:00 PM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">01:30 PM</button>
                            <button type="button" class="btn btn-outline-primary mx-1 my-1 time-slot">02:00 PM</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Appointments</button>
                </form>
                <div id="message"></div>
            </div>
            <%- include('layouts/footer') %>
                <%- include('layouts/scripts') %>
                    <script>
                        document.getElementById('date').addEventListener('change', async (e) => {
                            const date = e.target.value;
                            const response = await fetch(`/appointments?date=${date}`);
                            const result = await response.json();

                            if (result.success) {
                                const timeSlotsContainer = document.getElementById('timeSlotsContainer');
                                const timeSlotButtons = timeSlotsContainer.querySelectorAll('.time-slot');
                                timeSlotButtons.forEach(button => {
                                    button.classList.remove('selected');
                                    button.classList.remove('btn-secondary');
                                    button.classList.add('btn-outline-primary');
                                    button.disabled = false;
                                });

                                result.appointments.forEach(appointment => {
                                    const button = Array.from(timeSlotButtons).find(btn => btn.textContent === appointment.time);
                                    if (button) {
                                        button.classList.remove('btn-outline-primary');
                                        button.classList.add('btn-secondary');
                                        button.disabled = true;
                                    }
                                });
                            }
                        });

                        document.querySelectorAll('.time-slot').forEach(button => {
                            button.addEventListener('click', () => {
                                button.classList.toggle('selected');
                            });
                        });

                        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const date = document.getElementById('date').value;
                            const selectedSlots = Array.from(document.querySelectorAll('.time-slot.selected')).map(button =>
                                button.textContent);

                            const response = await fetch('/appointments', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ date, slots: selectedSlots })
                            });

                            const result = await response.json();
                            document.getElementById('message').textContent = result.message;

                            if (result.success) {
                                document.querySelectorAll('.time-slot.selected').forEach(button => {
                                    button.classList.remove('selected');
                                    button.classList.remove('btn-outline-primary');
                                    button.classList.add('btn-secondary');
                                    button.disabled = true;
                                });
                            }
                        });
                    </script>
    </body>

</html>